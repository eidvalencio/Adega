return jsonMatch ? jsonMatch[1] : textResponse;
                }
                return textResponse;
            }
            throw new Error("A IA processou o pedido mas n√£o devolveu texto leg√≠vel.");
        }

        // ===================================================================================
        // L√ìGICA DA APLICA√á√ÉO (UI, Eventos, etc.)
        // ===================================================================================

        function createWineFingerprint(wineInfo) {
            const name = (wineInfo.wineName || '').trim().toLowerCase();
            const grape = (wineInfo.grape || 'desconhecida').trim().toLowerCase();
            const year = wineInfo.year || 0;
            return `${name}-${grape}-${year}`;
        }

        function renderWineList(wines) {
            wineList.innerHTML = '';
            emptyMessage.classList.toggle('hidden', wines.length > 0);

            const totalQuantity = wines.reduce((sum, wine) => sum + (wine.quantity || 0), 0);
            totalWineCountDisplay.textContent = totalQuantity;

            wines.sort((a, b) => (a.wineName || '').localeCompare(b.wineName || '')).forEach(wine => {
                const wineElement = document.createElement('div');
                wineElement.className = 'bg-stone-900 bg-opacity-60 p-4 rounded-xl flex justify-between items-center transition-all duration-300 hover:bg-opacity-80 hover:scale-[1.02] cursor-pointer shadow-md border-l-4 border-red-700';
                wineElement.onclick = () => showStockWineDetails(wine);
                wineElement.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-white">${wine.wineName || 'Nome Desconhecido'} ${wine.year ? `<span class="text-sm text-gray-400">(${wine.year})</span>` : ''}</p>
                        <p class="text-sm text-red-300">${wine.grape || 'Uva Desconhecida'} - ${wine.region || 'Regi√£o Desconhecida'}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="bg-red-800 text-white text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full">${wine.quantity}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                `;
                wineList.appendChild(wineElement);
            });
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoadingModal('Analisando o r√≥tulo...');
            try {
                const base64Image = await toBase64(file);
                const prompt = `Voc√™ √© a "Adega Inteligente", uma IA sommelier. Analise a imagem do r√≥tulo de vinho. Extraia as informa√ß√µes e retorne ESTRITAMENTE em formato JSON. O objeto deve ter: "wineName" (string), "grape" (string), "region" (string), "year" (n√∫mero ou null), "description" (string, max 250 caracteres), "foodPairings" (array de 5 strings). Se n√£o encontrar uma informa√ß√£o, retorne null para o campo correspondente, mas sempre retorne o JSON completo.`;
                
                // Agora enviamos 'true' para garantir que a IA nos devolve JSON
                const jsonResponse = await callGenerativeAI(prompt, base64Image, true);
                const wineInfo = JSON.parse(jsonResponse);
                
                if (wineInfo && wineInfo.wineName) {
                    showScannedWineModal(wineInfo);
                } else {
                    showErrorModal('N√£o foi poss√≠vel analisar o r√≥tulo. Tente uma foto com melhor ilumina√ß√£o e foco.');
                }
            } catch (error) {
                console.error("Erro no processo de upload:", error);
                showErrorModal(`Ocorreu um erro ao comunicar com a IA.\n\nDetalhes:\n${error.message}`);
            } finally {
                hideLoadingModal();
                cameraInput.value = '';
                galleryInput.value = '';
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        function addWine(wineInfo) {
            const wines = [...currentWines];
            const newWineFingerprint = createWineFingerprint(wineInfo);
            const existingWineIndex = wines.findIndex(w => createWineFingerprint(w) === newWineFingerprint);

            if (existingWineIndex > -1) {
                wines[existingWineIndex].quantity++;
            } else {
                wines.push({ ...wineInfo, quantity: 1, id: Date.now() });
            }
            saveWinesToFirebase(wines);
            closeModal();
        }

        function drinkWine(wineInfo) {
            let wines = [...currentWines];
            const wineToDrinkFingerprint = createWineFingerprint(wineInfo);
            const existingWineIndex = wines.findIndex(w => createWineFingerprint(w) === wineToDrinkFingerprint);

            if (existingWineIndex > -1) {
                wines[existingWineIndex].quantity--;
                if (wines[existingWineIndex].quantity <= 0) {
                    wines = wines.filter((_, index) => index !== existingWineIndex);
                }
                saveWinesToFirebase(wines);
            }
            closeModal();
        }

        function openModal() {
            modalBackdrop.classList.remove('hidden', 'modal-scale-enter-from');
            modalContainer.classList.remove('hidden');
            modalContent.classList.remove('modal-scale-enter-from');
            modalBackdrop.classList.add('modal-scale-enter-to');
            modalContent.classList.add('modal-scale-enter-to');
        }

        function closeModal() {
            modalBackdrop.classList.remove('modal-scale-enter-to');
            modalContent.classList.remove('modal-scale-enter-to');
            modalBackdrop.classList.add('modal-scale-leave-to');
            modalContent.classList.add('modal-scale-leave-to');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                modalContainer.classList.add('hidden');
                modalContent.innerHTML = '';
            }, 200);
        }

        function showLoadingModal(text) { loadingText.textContent = text; loadingModal.classList.remove('hidden'); }
        function hideLoadingModal() { loadingModal.classList.add('hidden'); }

        function showImageSourceModal() {
            const btnClass = "font-bold py-4 px-4 rounded-lg w-full transition-transform transform hover:scale-105 text-lg flex items-center justify-center gap-3";
            modalContent.innerHTML = `
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                <h2 class="font-serif text-3xl text-white mb-6 text-center">Adicionar Vinho</h2>
                <div class="flex flex-col gap-4">
                    <button id="open-camera-btn" class="bg-red-800 hover:bg-red-700 text-white ${btnClass}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        Tirar Foto com a C√¢mera
                    </button>
                    <button id="open-gallery-btn" class="bg-gray-600 hover:bg-gray-500 text-white ${btnClass}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        Escolher da Galeria
                    </button>
                </div>
            `;
            openModal();
            modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            modalContent.querySelector('#open-camera-btn').onclick = () => {
                cameraInput.click();
                closeModal();
            };
            modalContent.querySelector('#open-gallery-btn').onclick = () => {
                galleryInput.click();
                closeModal();
            };
        }

        function showScannedWineModal(wineInfo) {
            const newWineFingerprint = createWineFingerprint(wineInfo);
            const existingWine = currentWines.find(w => createWineFingerprint(w) === newWineFingerprint);
            const isInStock = !!existingWine;
            const btnClass = "font-bold py-3 px-4 rounded-lg w-full transition-transform transform hover:scale-105";

            modalContent.innerHTML = `
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                <h2 class="font-serif text-3xl text-white mb-2">${wineInfo.wineName || 'Nome Desconhecido'} ${wineInfo.year ? `(${wineInfo.year})` : ''}</h2>
                <p class="text-red-300 mb-4">${wineInfo.grape || 'Uva Desconhecida'} - ${wineInfo.region || 'Regi√£o Desconhecida'}</p>
                <div class="space-y-4">
                    <div class="bg-stone-900 bg-opacity-50 p-4 rounded-lg"><h3 class="font-bold text-lg mb-2 text-white">Sobre este vinho</h3><p class="text-gray-300">${wineInfo.description || 'Descri√ß√£o n√£o dispon√≠vel.'}</p></div>
                    <div class="bg-stone-900 bg-opacity-50 p-4 rounded-lg"><h3 class="font-bold text-lg mb-2 text-white">Harmoniza√ß√£o Sugerida</h3><ul class="list-disc list-inside text-gray-300 space-y-1">${(wineInfo.foodPairings || []).map(p => `<li>${p}</li>`).join('')}</ul></div>
                </div>
                <div class="mt-6 flex flex-col gap-3">
                    <button class="add-wine-btn bg-red-800 hover:bg-red-700 text-white ${btnClass}">
                        ${isInStock ? 'Adicionar +1 Garrafa' : 'Adicionar ao Estoque'}
                    </button>
                    ${isInStock ? `<button class="drink-wine-btn bg-green-700 hover:bg-green-600 text-white ${btnClass}">Beber 1 Garrafa</button>` : ''}
                </div>`;

            openModal();

            modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            modalContent.querySelector('.add-wine-btn').onclick = () => addWine(wineInfo);
            if (isInStock) {
                modalContent.querySelector('.drink-wine-btn').onclick = () => drinkWine(wineInfo);
            }
        }

        function showStockWineDetails(wineInfo) {
            const btnClass = "font-bold py-3 px-4 rounded-lg w-full transition-transform transform hover:scale-105";
            modalContent.innerHTML = `
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                <h2 class="font-serif text-3xl text-white mb-2">${wineInfo.wineName} ${wineInfo.year ? `(${wineInfo.year})` : ''}</h2>
                <p class="text-red-300 mb-4">${wineInfo.grape} - ${wineInfo.region}</p>
                <p class="text-gray-300 mb-6 text-center bg-stone-900 bg-opacity-50 p-3 rounded-lg">Voc√™ tem <strong>${wineInfo.quantity}</strong> garrafa(s) em estoque.</p>
                <div class="flex flex-col gap-3">
                    <button class="tech-sheet-btn bg-gray-600 hover:bg-gray-500 text-white ${btnClass}">‚ú® Gerar Ficha T√©cnica</button>
                    <button class="add-wine-btn bg-blue-600 hover:bg-blue-700 text-white ${btnClass}">Adicionar +1 Garrafa</button>
                    <button class="drink-wine-btn bg-green-700 hover:bg-green-600 text-white ${btnClass}">Beber 1 Garrafa</button>
                </div>`;

            openModal();

            modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            modalContent.querySelector('.tech-sheet-btn').onclick = () => generateTechSheet(wineInfo);
            modalContent.querySelector('.add-wine-btn').onclick = () => addWine(wineInfo);
            modalContent.querySelector('.drink-wine-btn').onclick = () => drinkWine(wineInfo);
        }

        function showErrorModal(message) {
            modalContent.innerHTML = `
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                <h2 class="font-serif text-3xl text-red-400 mb-2">Ocorreu um Erro</h2>
                <p class="text-gray-300 break-words whitespace-pre-wrap">${message}</p>`;
            openModal();
            modalContent.querySelector('.close-modal-btn').onclick = closeModal;
        }

        async function generateTechSheet(wineInfo) {
            showLoadingModal('A gerar ficha t√©cnica...');
            try {
                const prompt = `Gere uma "ficha t√©cnica" detalhada para o vinho "${wineInfo.wineName} ${wineInfo.year || ''}" da regi√£o "${wineInfo.region}" com uva "${wineInfo.grape}". Formate com emojis. Inclua: üå°Ô∏è Temperatura Ideal, ‚è≥ Potencial de Guarda, üìù Nota de Prova (visual, olfativo, gustativo), üßê Curiosidade, üåü Nota Estimada (0-100).`;
                const techSheetText = await callGenerativeAI(prompt);
                modalContent.innerHTML = `
                    <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                    <h2 class="font-serif text-3xl text-white mb-4">‚ú® Ficha T√©cnica</h2>
                    <div class="text-gray-300 space-y-3 whitespace-pre-wrap">${techSheetText.replace(/\n/g, '<br>')}</div>`;
                modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            } catch (error) {
                console.error("Erro ao gerar ficha:", error);
                showErrorModal(`Ocorreu um erro ao comunicar com a IA.\n\nDetalhes:\n${error.message}`);
            } finally {
                hideLoadingModal();
            }
        }

        function openChatModal() {
            const chatHistory = [{ role: 'ai', text: 'Ol√°! Sou seu sommelier virtual. Como posso ajudar hoje? Pergunte sobre harmoniza√ß√µes, uvas ou pe√ßa uma recomenda√ß√£o!' }];
            modalContent.innerHTML = `
                <div class="flex justify-between items-center pb-3 border-b border-gray-700">
                    <h2 class="font-serif text-2xl text-white">‚ú® Converse com o Sommelier</h2>
                    <button class="close-modal-btn text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div id="chat-messages" class="flex-1 py-4 space-y-4 overflow-y-auto flex flex-col h-80 my-4 custom-scrollbar">
                    ${chatHistory.map(msg => `<div class="chat-bubble ${msg.role === 'user' ? 'user-bubble bg-red-800 self-end' : 'ai-bubble bg-stone-700 self-start'} rounded-xl max-w-[85%] p-3 text-white">${msg.text}</div>`).join('')}
                </div>
                <div class="pt-3 border-t border-gray-700">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-stone-800 border border-gray-600 rounded-full px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Pergunte sobre vinhos...">
                        <button type="submit" class="bg-red-800 hover:bg-red-700 text-white font-bold p-3 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/></svg></button>
                    </form>
                </div>`;
            openModal();

            modalContent.querySelector('.close-modal-btn').onclick = closeModal;

            const chatForm = document.getElementById('chat-form');
            chatForm.onsubmit = async (e) => {
                e.preventDefault();
                const chatInput = document.getElementById('chat-input');
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                addChatMessage(userMessage, 'user');
                chatInput.value = '';
                try {
                    const stock = currentWines.map(w => `- ${w.quantity}x ${w.wineName || 'Vinho Desconhecido'} (${w.grape || 'Uva Desconhecida'}, ${w.year || 'S.A.'})`).join('\n');
                    const prompt = `Voc√™ √© um Master Sommelier da "Adega Inteligente". Sua principal fun√ß√£o √© a harmoniza√ß√£o precisa.

**DIRETIVA DE TR√äS EST√ÅGIOS:**

1.  **AN√ÅLISE DE ESTOQUE (PRIORIDADE M√ÅXIMA):** Primeiro, analise o prato do usu√°rio ("${userMessage}") e compare-o com os vinhos que ele possui em estoque:\n${stock || 'Nenhum'}\nSe houver uma harmoniza√ß√£o boa ou excelente, sua resposta DEVE come√ßar com "Da sua adega, a melhor op√ß√£o √©..." e recomende o vinho, explicando o porqu√™ da harmoniza√ß√£o.

2.  **RECOMENDA√á√ÉO DE COMPRA (PLANO B):** Se, e somente se, nenhum vinho do estoque for uma boa op√ß√£o, sua resposta DEVE come√ßar com "Para este prato, a harmoniza√ß√£o ideal seria..." e sugira o tipo de vinho a ser comprado (uva, regi√£o, caracter√≠sticas).

3.  **PROATIVIDADE CULIN√ÅRIA (ENGAJAMENTO):** Se o usu√°rio pedir uma receita, forne√ßa uma. Caso contr√°rio, sempre que apropriado, finalize suas respostas com uma pergunta aberta para engajar o usu√°rio, como "Gostaria de uma sugest√£o de receita para acompanhar este prato?".

**REQUISI√á√ÉO DO USU√ÅRIO:** "${userMessage}"`;
                    const aiResponse = await callGenerativeAI(prompt);
                    addChatMessage(aiResponse, 'ai');
                } catch (error) {
                    addChatMessage(`Desculpe, estou com problemas de liga√ß√£o. Detalhes: ${error.message}`, 'ai');
                }
            };
        }

        function addChatMessage(text, role) {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            const bubbleClass = role === 'user' ? 'bg-red-800 self-end' : 'bg-stone-700 self-start';
            messageEl.className = `chat-bubble rounded-xl max-w-[85%] p-3 text-white ${bubbleClass}`;
            messageEl.textContent = text;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- NOVAS FUN√á√ïES DE IA (SURPRISE ME & DINNER PLANNER) ---
        async function suggestWineForTonight() {
            if (currentWines.length === 0) {
                showErrorModal("A sua adega est√° vazia! Adicione alguns vinhos primeiro.");
                return;
            }
            showLoadingModal('O Sommelier est√° a escolher o vinho perfeito...');
            try {
                const stockList = currentWines.map(w => `- ${w.wineName} (${w.grape || 'Uva n√£o informada'}, ${w.year || 'S.A.'})`).join('\n');
                const prompt = `Atue como um Master Sommelier. Aqui est√° a minha adega atual:\n${stockList}\n\nEscolha APENAS UM vinho desta lista para eu beber hoje √† noite. Crie uma recomenda√ß√£o curta, po√©tica e tentadora (m√°ximo de 3 par√°grafos). Diga por que este √© o vinho perfeito para hoje, sugerindo o clima ideal (ex: m√∫sica, companhia, comida). Use formata√ß√£o HTML b√°sica (<b>, <i>, <br>, <p>) para estruturar o texto de forma elegante. N√£o use markdown na resposta, retorne apenas o HTML puro.`;
                const aiResponse = await callGenerativeAI(prompt);
                
                modalContent.innerHTML = `
                    <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                    <h2 class="font-serif text-3xl text-purple-400 mb-4">‚ú® A Escolha do Sommelier</h2>
                    <div class="text-gray-300 space-y-4 text-lg leading-relaxed bg-stone-900 bg-opacity-50 p-6 rounded-xl border border-purple-900/50">
                        ${aiResponse}
                    </div>`;
                openModal();
                modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            } catch (error) {
                console.error("Erro na sugest√£o:", error);
                showErrorModal(`Erro ao consultar o Sommelier.\n\nDetalhes:\n${error.message}`);
            } finally {
                hideLoadingModal();
            }
        }

        function openDinnerPlannerModal() {
            if (currentWines.length === 0) {
                showErrorModal("A sua adega est√° vazia! Adicione vinhos para harmonizar com o jantar.");
                return;
            }
            modalContent.innerHTML = `
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                <h2 class="font-serif text-3xl text-indigo-400 mb-4">üçΩÔ∏è Planear um Jantar</h2>
                <p class="text-gray-300 mb-4">Qual √© a ocasi√£o ou o tema do jantar? (ex: Jantar Rom√¢ntico, Churrasco com Amigos, Noite de Massas)</p>
                <form id="dinner-form" class="flex flex-col gap-4">
                    <input type="text" id="dinner-theme-input" class="bg-stone-800 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full" placeholder="Digite o tema do jantar..." required>
                    <button type="submit" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform transform hover:scale-105">
                        ‚ú® Gerar Menu Harmonizado
                    </button>
                </form>
            `;
            openModal();
            modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            
            document.getElementById('dinner-form').onsubmit = async (e) => {
                e.preventDefault();
                const theme = document.getElementById('dinner-theme-input').value.trim();
                if (!theme) return;
                generateDinnerMenu(theme);
            };
        }

        async function generateDinnerMenu(theme) {
            showLoadingModal('A criar um menu inesquec√≠vel...');
            try {
                const stockList = currentWines.map(w => `- ${w.wineName} (${w.grape || 'Uva n√£o informada'}, ${w.year || 'S.A.'})`).join('\n');
                const prompt = `Atue como um Chef com estrela Michelin e um Master Sommelier. O usu√°rio vai dar um jantar com o tema: "${theme}".
Sua tarefa √© criar um menu incr√≠vel de 3 tempos (Entrada, Prato Principal e Sobremesa).
A regra de ouro: Voc√™ deve harmonizar CADA PRATO OBRIGATORIAMENTE com um dos vinhos dispon√≠veis na adega do usu√°rio listados abaixo:
\n${stockList}\n
Para cada prato, descreva a comida de forma apetitosa e explique por que o vinho escolhido da adega harmoniza perfeitamente com os sabores.
Use formata√ß√£o HTML para estruturar a resposta (use <h3>, <p>, <ul>, <li>, <strong>, <br>). N√£o use blocos de c√≥digo markdown, retorne apenas as tags HTML. Adicione emojis adequados.`;
                
                const aiResponse = await callGenerativeAI(prompt);
                
                modalContent.innerHTML = `
                    <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                    <h2 class="font-serif text-3xl text-indigo-400 mb-6">‚ú® Menu: ${theme}</h2>
                    <div class="text-gray-300 space-y-6 bg-stone-900 bg-opacity-50 p-6 rounded-xl border border-indigo-900/50 max-h-[60vh] overflow-y-auto custom-scrollbar [&>h3]:text-xl [&>h3]:font-bold [&>h3]:text-white [&>h3]:mt-6 [&>h3]:mb-2 [&>ul]:list-disc [&>ul]:ml-5 [&>p]:mb-2">
                        ${aiResponse}
                    </div>`;
                openModal();
                modalContent.querySelector('.close-modal-btn').onclick = closeModal;
            } catch (error) {
                console.error("Erro no planeamento:", error);
                showErrorModal(`Erro ao planear o jantar.\n\nDetalhes:\n${error.message}`);
            } finally {
                hideLoadingModal();
            }
        }

        // --- EVENT LISTENERS ---
        apiMonitor.addEventListener('click', () => {
            apiMonitor.classList.toggle('is-expanded');
        });
        addWineActionBtn.addEventListener('click', showImageSourceModal);
        cameraInput.addEventListener('change', handleImageUpload);
        galleryInput.addEventListener('change', handleImageUpload);
        askSommelierBtn.addEventListener('click', openChatModal);
        document.getElementById('btn-surprise-me').addEventListener('click', suggestWineForTonight);
        document.getElementById('btn-dinner-planner').addEventListener('click', openDinnerPlannerModal);

    </script>
</body>
</html>
